
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>DynatraceとKubernetes</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="../../elements/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid="UA-175467274-1"
                  id="kubernetes-jp"
                  title="DynatraceとKubernetes"
                  environment="web"
                  feedback-link="mailto:DT-TYO-SE@dynatrace.com">
    
      <google-codelab-step label="はじめに" duration="1">
        <p>このリポジトリには、Hands-On Kubernetes Sessionのラボが含まれています。今回のハンズオンでは、AWSで動作するKubernetesインスタンスを使用しますが、他のプラットフォームでも動作します。</p>
<p>Dynatrace主催のハンズオンワークショップへ参加されている方には環境が自動で払い出されます。</p>
<h2 is-upgraded>事前準備</h2>
<ul>
<li>DynatraceのAccount. フリートライアルの申し込み <a href="https://www.dynatrace.com/trial/" target="_blank">here</a></li>
<li>Chrome ブラウザ</li>
<li>SSH クライアント <a href="https://mobaxterm.mobatek.net/" target="_blank">mobaxterm</a></li>
</ul>
<h2 is-upgraded>学習内容</h2>
<ul>
<li>Dynatrace Operatorの導入</li>
<li>自動作成されたKubernetesのダッシュボードの確認</li>
<li>Kubernetesにおけるラベルとアノテーション</li>
<li>Kubernetesのプロセスグループネーミングとサービスネーミング</li>
<li>Dynatrace上でのKubernetes情報の確認  <ul>
<li>Namespace</li>
<li>ワークロード</li>
<li>コンテナ/ポッド</li>
</ul>
</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Dynatrace Operatorの導入" duration="15">
        <p>この演習では、Kubernetes(Microk8s)を実行しているLinuxインスタンスにOneAgentをデプロイし、そのインスタンスで何が実行されているかOneAgentが見つけたものを確認します。</p>
<h2 is-upgraded>ブラウザ経由でのターミナルアクセス</h2>
<p>ラボを円滑に進めるために、Linuxインスタンスに<strong>Webブラウザを介したターミナル</strong>でアクセスします。</p>
<p>メールに記載されている<strong>URL</strong>を使用して、SSHターミナルにアクセスします。URLが <code>Public IP Address:8080/wetty</code> のようになっていることを確認してください。</p>
<p>メールに記載されている<strong>ログイン名</strong>と<strong>パスワード</strong>を使用します。</p>
<p class="image-container"><img alt="Deploy" src="../assets/dem/wetty.png"></p>
<h2 is-upgraded>OneAgentのダウンロード</h2>
<p>ブラウザを開き、DynatraceのGUIにアクセスしてください。</p>
<p>以下の手順で進めてください。</p>
<ul>
<li>ナビゲーションメニューから <strong>Hub</strong> を検索します。</li>
<li><strong>Star</strong>を付けてお気に入りに追加し、<strong>クリック</strong>します。</li>
<li><strong>Kubernetes</strong> を選択します。</li>
<li>右下の <strong>Monitor Kubernetes</strong> ボタンを選択します。</li>
</ul>
<p class="image-container"><img alt="Deploy" src="../assets/cloud-observe/k8s-deploy.gif"></p>
<p><strong>Monitor Kubernetes / Openshift</strong>ページ内で、以下の手順を行います。</p>
<ul>
<li><strong>名前</strong> を入力してください 例：<code>k8s</code></li>
<li><strong>Create tokens</strong>をクリックして、適切なパーミッションのPaaSおよびAPIトークンを作成してください。</li>
<li>Skip SSL Certificate Checkを有効にします。</li>
<li><strong>Copy</strong> ボタンをクリックしてコマンドをコピーしてください。</li>
<li>ターミナルウィンドウに貼り付けて実行してください。</li>
</ul>
<p class="image-container"><img alt="Deploy" src="../assets/cloud-observe/k8s-deploy-2.gif"></p>
<p>出力例</p>
<pre><code language="language-bash" class="language-bash">Connecting to github-releases.githubusercontent.com (github-releases.githubusercontent.com)|185.199.108.154|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 7310 (7.1K) [application/octet-stream]
Saving to: ‘install.sh&#39;

install.sh                      100%[=====================================================&gt;]   7.14K  --.-KB/s    in 0s      

2021-06-01 05:46:36 (40.7 MB/s) - ‘install.sh&#39; saved [7310/7310]


Check for token scopes...

Check if cluster already exists...

Creating Dynatrace namespace...

Applying Dynatrace Operator...
Warning: apiextensions.k8s.io/v1beta1 CustomResourceDefinition is deprecated in v1.16+, unavailable in v1.22+; use apiextensions.k8s.io/v1 CustomResourceDefinition
customresourcedefinition.apiextensions.k8s.io/dynakubes.dynatrace.com created
serviceaccount/dynatrace-dynakube-oneagent created
serviceaccount/dynatrace-dynakube-oneagent-unprivileged created
serviceaccount/dynatrace-kubernetes-monitoring created
serviceaccount/dynatrace-operator created
serviceaccount/dynatrace-routing created
podsecuritypolicy.policy/dynatrace-dynakube-oneagent created
podsecuritypolicy.policy/dynatrace-dynakube-oneagent-unprivileged created
podsecuritypolicy.policy/dynatrace-kubernetes-monitoring created
podsecuritypolicy.policy/dynatrace-operator created
podsecuritypolicy.policy/dynatrace-routing created
role.rbac.authorization.k8s.io/dynatrace-dynakube-oneagent created
role.rbac.authorization.k8s.io/dynatrace-dynakube-oneagent-unprivileged created
role.rbac.authorization.k8s.io/dynatrace-kubernetes-monitoring created
role.rbac.authorization.k8s.io/dynatrace-operator created
role.rbac.authorization.k8s.io/dynatrace-routing created
clusterrole.rbac.authorization.k8s.io/dynatrace-kubernetes-monitoring created
clusterrole.rbac.authorization.k8s.io/dynatrace-operator created
rolebinding.rbac.authorization.k8s.io/dynatrace-dynakube-oneagent created
rolebinding.rbac.authorization.k8s.io/dynatrace-dynakube-oneagent-unprivileged created
rolebinding.rbac.authorization.k8s.io/dynatrace-kubernetes-monitoring created
rolebinding.rbac.authorization.k8s.io/dynatrace-operator created
rolebinding.rbac.authorization.k8s.io/dynatrace-routing created
clusterrolebinding.rbac.authorization.k8s.io/dynatrace-kubernetes-monitoring created
clusterrolebinding.rbac.authorization.k8s.io/dynatrace-operator created
deployment.apps/dynatrace-operator created
W0601 05:46:39.025776   29593 helpers.go:553] --dry-run is deprecated and can be replaced with --dry-run=client.
secret/dynakube configured

Applying DynaKube CustomResource...
dynakube.dynatrace.com/dynakube created

Adding cluster to Dynatrace...
Kubernetes monitoring successfully setup.
$

</code></pre>
<aside class="warning"><p>Dynatraceにデータが表示されるまで約5分かかります。</p>
</aside>
<aside class="special"><p>Dynatraceは、OneAgentsの自動展開や、k8sの自動統合を行います。</p>
</aside>
<h2 is-upgraded>インストールの確認</h2>
<p><strong>Show deployment status</strong>をクリックすると、接続されているホストの状態を確認することができます。</p>
<p>下の画像のように、接続されたホストが表示されているはずです。</p>
<p class="image-container"><img alt="Deploy" src="../assets/dem/download-deployment-status-1.png"></p>
<aside class="special"><p>詳しいドキュメントは<a href="https://www.dynatrace.com/support/help/technology-support/operating-systems/linux/" target="_blank">こちら</a>を参照ください。</p>
</aside>
<h2 is-upgraded>⚠️ トラブルシューティングの手順</h2>
<aside class="warning"><p><strong>ポッドの状態を確認</strong>するには、以下のコマンドを実行します。すると、<strong>Running</strong>という結果が返ってくるはずです。<br><code>kubectl get pods -n dynatrace</code></p>
</aside>
<aside class="warning"><p><strong>ログの確認</strong>は、以下のコマンドを実行します。<br><code>kubectl logs -f deployment/dynatrace-oneagent-operator -n dynatrace</code></p>
</aside>
<aside class="warning"><p><strong>シークレットを削除</strong>するには、以下のコマンドを実行してください。誤ったシークレットが含まれている可能性があります。 <br><code>kubectl delete secret --all -n dynatrace</code></p>
</aside>
<aside class="warning"><p><strong>すべてのポッドを削除</strong>するには、以下のコマンドを実行してください。これにより、すべてのポッドが削除され、新しいポッドインスタンスが作成されます。<br><code>kubectl delete --all pods -n dynatrace</code></p>
</aside>
<aside class="warning"><p>公式サイトのトラブルシューティングページは<a href="https://www.dynatrace.com/support/help/setup-and-configuration/setup-on-container-platforms/kubernetes/troubleshoot-k8s-deployment-and-connectivity/" target="_blank">こちら</a>を参照ください。</p>
</aside>
<p>すべてがうまくいっていれば、<strong>Show Deployment status</strong>をクリックすると、ホストが表示されます。</p>

<h2 is-upgraded>Sockshopアプリケーションの再起動</h2>
<p>様々なプロセスが自動的に検出されているのがわかりますが、Dynatraceはそれらを再起動するよう促します。これは、コードを変更せずに自動的に監視を行うために必要です。</p>
<p>以下のコマンドを実行して、<strong>Dev</strong>と<strong>Production</strong>のPodsを作り直します。</p>
<pre><code language="language-bash" class="language-bash">kubectl delete pods --all -n dev
kubectl delete pods --all -n production
</code></pre>

<h2 is-upgraded>Kubernetes integrationの設定</h2>
<p>DynatraceのUIから<strong>Settings &gt; Cloud and virtualization &gt; Kubernetes</strong>を開きます。</p>
<p>以下の設定を実施します。</p>
<ul>
<li>作成されたKubernetesクラスタの<strong>鉛筆のアイコン</strong>をクリックします。</li>
<li><strong>Monitor annotated Prometheus exporters</strong>を有効にします。</li>
<li><strong>Monitor events</strong>を有効にします。</li>
<li><strong>Include all events relevant for Davis</strong>を有効にします。</li>
<li><strong>Save</strong>をクリックします。</li>
</ul>
<p class="image-container"><img alt="settings" src="../assets/k8s/k8s-configure.gif"></p>



      </google-codelab-step>
    
      <google-codelab-step label="Prometheusメトリクスのインポート" duration="10">
        <p>アプリケーションには、Nginx、Redis、RabbitMQ、MySQL、MongoDBなどのサードパーティのテクノロジーが使用されていることが多く、これらについては、メトリクスの観点からさらなる洞察が必要となります。</p>
<p>Dynatraceでは、Prometheusと同じ形式のメトリクスを取り込むことができ、マイクロサービスやポッドのより大きな文脈の中にそれらを取り込み、これらのメトリクスの<strong>自動適応ベースライン化</strong>による<strong>強化されたアラート</strong>を可能にします。</p>
<p>さらに良いことに、Dynatraceはスクレイピングを実行してくれるので、<strong>Prometheusサーバーは必要ありません</strong>。</p>
<p class="image-container"><img alt="Prometheus scraping" src="../assets/k8s/prometheus-scrap.png"></p>
<h2 is-upgraded>Prometheusエクスポーターポッドのアノテーション</h2>
<p>シェルターミナルに戻り、次のコマンドを実行して、ポッドに<strong>Prometheus scraping</strong>のためにannotationを付与します。</p>
<p>このコマンドは、<strong>Production</strong> namespace内のポッドにアノテートを付与します。</p>
<pre><code language="language-bash" class="language-bash">kubectl annotate po -n production --all --overwrite metrics.dynatrace.com/scrape=true
kubectl annotate po -n production --all --overwrite metrics.dynatrace.com/port=8080
</code></pre>
<aside class="special"><p>上記手順に関する詳細は<a href="https://www.dynatrace.com/support/help/how-to-use-dynatrace/infrastructure-monitoring/container-platform-monitoring/kubernetes-monitoring/monitor-prometheus-metrics/#annotate-prometheus-exporter-pods" target="_blank">公式サイト</a>を参照ください。</p>
</aside>
<h2 is-upgraded>メトリクスの探索</h2>
<p>1～2分ほど待ってから、Dynatrace UIで</p>
<ul>
<li><strong>Metrics</strong> ビューに移動します。</li>
<li><strong>filter</strong> テキストボックスに<code>process_</code>と入力し、<strong>&#34;Enter &#34;</strong>キーを押してください。</li>
<li>いくつかの異なるメトリクスが表示されます。これらはPrometheusから抜粋したものです。何も表示されない場合は、もう少し待ってから、画面を更新して再度試してみてください。</li>
</ul>
<p class="image-container"><img alt="Metrics browser" src="../assets/k8s/prometheus-metrics1.png"></p>
<ul>
<li>いずれかの項目をクリックすると、収集されたメトリクスを <strong>dimensions</strong> も含めて調べることができます。Dynatraceは、Kubernetesのワークロード、ネームスペース、ノードなどを <strong>自動的に関連付け</strong>、これを原因究明エンジンに送り込んでいることに注目してください。</li>
</ul>
<p class="image-container"><img alt="Metrics browser" src="../assets/k8s/prometheus-metrics2.png"></p>
<p>これで、これらのメトリクスを簡単に <strong>チャート化</strong> したり、** ダッシュボード** を作成することができます。ダッシュボードのサンプルは後ほどハンズオンでご紹介しますので、参考にしてください。</p>
<p>さらに、メトリクスに基づいてアラートを作成することもできます。</p>
<h2 is-upgraded>メトリクスに基づくカスタムアラートを取得する方法</h2>
<aside class="warning"><p>カスタムアラートはハンズオンの範囲ではありませんが、セッション終了後、ご自身で自由にお試しいただけます。</p>
</aside>
<p>PrometheusのメトリクスをDynatraceで利用できるようになりました。サードパーティ製ではありますが、これらのメトリクスもDynatraceのメトリクスとして扱われます。</p>
<p>Dynatraceネイティブのメトリクスと同じように、チャートやダッシュボードでそれらのメトリクスを視覚化できることはすでに見てきました。</p>
<p>しかし、もちろん、ダッシュボードを見ることに毎日を費やしたくはないでしょう。欲しいのは、キャプチャしているメトリクスに関連する異常があった場合に通知されることです。</p>
<p>メトリクスに対して<a href="https://www.dynatrace.com/support/help/how-to-use-dynatrace/problem-detection-and-analysis/problem-detection/metric-events-for-alerting/" target="_blank">custom Anomaly Detection rule</a>を定義することができます。</p>
<p>セッション終了後、お時間のある方はぜひお試しください。</p>



      </google-codelab-step>
    
      <google-codelab-step label="Kubernetesにおけるラベルとアノテーション" duration="15">
        <p>Sockshopアプリを再起動すると、Dynatraceにサービスが表示されるようになります。</p>
<p><code>~/sockshop/manifests/sockshop-app/production/front-end.yml</code>を参考にして、Dynatraceが自動的にアノテーションとラベルを拾うように設定したいと思います。</p>
<pre><code language="language-bash" class="language-bash">---
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: front-end.stable
    product: sockshop
    release: stable
    stage: prod
    tier: frontend
    version: &#34;1.4&#34;
  name: front-end.stable
  namespace: production
spec:
  replicas: 1
  selector:
    matchLabels:
      app: front-end.stable
      product: sockshop
      release: stable
      stage: prod
      tier: frontend
      version: &#34;1.4&#34;
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      annotations:
        pipeline.build: 1.4.0.7424
        pipeline.project: sockshop
        pipeline.stage: prod-stable
        sidecar.istio.io/inject: &#34;false&#34;
        support.channel: &#39;#support-sockshop-frontend&#39;
        support.contact: jane.smith@sockshop.com
      labels:
        app.kubernetes.io/name: front-end
        app.kubernetes.io/version: &#34;1.4&#34;
        app.kubernetes.io/part-of: sockshop
        app: front-end.stable
        product: sockshop
        release: stable
        stage: prod
        tier: frontend
        version: &#34;1.4&#34;
</code></pre>
<h2 is-upgraded>サービスアカウントへのview role の割り当て</h2>
<p>OneAgentはサービスアカウントを使用して、Kubernetes REST APIを介してメタデータを照会します。 そのためにはサービスアカウントに、<strong>viewer role</strong>が付与されている必要があります。 CLIで、<strong>production project</strong>に対して以下のコマンドを実行します。</p>
<pre><code language="language-bash" class="language-bash">kubectl create rolebinding serviceaccounts-view --clusterrole=view --group=system:serviceaccounts:production --namespace=production
</code></pre>
<p><strong>dev project</strong>に対しても同様に実行します。</p>
<pre><code language="language-bash" class="language-bash">kubectl create rolebinding serviceaccounts-view --clusterrole=view --group=system:serviceaccounts:dev --namespace=dev
</code></pre>
<p>Dynatraceが変更を認識するまで待ちます。</p>
<aside class="warning"><p>⚠️ アプリを手動でリサイクルするには、以下のコマンドを実行してください。 <code>wget -O- https://raw.githubusercontent.com/Dynatrace-APAC/Workshop-Kubernetes/master/recycle-sockshop-frontend.sh | bash</code></p>
</aside>
<h2 is-upgraded>確認</h2>
<p>作業が完了したら、Dynatraceで変更を検証することができます。</p>
<p class="image-container"><img alt="JSON" src="../assets/k8s/Picture12.png"></p>
<aside class="special"><p>詳細は<a href="https://www.dynatrace.com/support/help/technology-support/container-platforms/kubernetes/other-deployments-and-configurations/leverage-tags-defined-in-kubernetes-deployments/" target="_blank">公式サイト</a>をご確認ください。</p>
</aside>



      </google-codelab-step>
    
      <google-codelab-step label="コンテナ環境変数" duration="15">
        <h2 is-upgraded>環境変数の追加</h2>
<p>シェルターミナルで、以下のコマンドで環境変数を追加します。</p>
<p><code>nano ~/sockshop/manifests/sockshop-app/production/front-end.yml</code></p>
<p><strong>インデントが正しく行われているか、エラープロンプトが表示されていないかを確認してください。</strong></p>
<pre><code language="language-bash" class="language-bash">        env:
        - name: DT_TAGS
          value: &#34;product=sockshop&#34;
        - name: DT_CUSTOM_PROP
          value: &#34;SERVICE_TYPE=FRONTEND&#34;
</code></pre>
<p class="image-container"><img alt="JSON" src="../assets/k8s/Picture13.png"></p>
<p>修正したファイルを<strong>Ctrl-X</strong>、<strong>Y</strong>、<strong>Enter</strong>で保存し、以下のコマンドを実行して変更を再適用します。</p>
<pre><code language="language-bash" class="language-bash">kubectl apply -f ~/sockshop/manifests/sockshop-app/production/front-end.yml
wget -O- https://raw.githubusercontent.com/Dynatrace-APAC/Workshop-Kubernetes/master/recycle-sockshop-frontend.sh | bash
</code></pre>
<h2 is-upgraded>確認</h2>
<p>作業が完了したら、Dynatraceで変更を検証することができます。</p>
<p class="image-container"><img alt="JSON" src="../assets/k8s//Picture14.png"></p>



      </google-codelab-step>
    
      <google-codelab-step label="Kubernetesのプロセスグループネーミングとサービスネーミング" duration="15">
        <p><strong>Settings -&gt; Processes and containers -&gt; Process group naming</strong>へ移動し、<strong>Add a new rule</strong>をクリックします。</p>
<p>ルールに名前を付けてください（例: <strong>Kubernetes Project.Namespace.Container</strong>）</p>
<p><code>k8s-{ProcessGroup:Kubernetes:pipeline.project}.{ProcessGroup:KubernetesNamespace}.{ProcessGroup:KubernetesContainerName}</code> という形式で入力してください。</p>
<p>Conditionsドロップダウンリストでは, <strong>Kubernetes namespace</strong>と<strong>exists</strong>を選択します。</p>
<p class="image-container"><img alt="JSON" src="../assets/k8s/Picture15.png"></p>
<p><strong>Preview</strong>をクリックし、マッチしているエントリーを確認します。</p>
<p class="image-container"><img alt="JSON" src="../assets/k8s/Picture16.png"></p>
<p><strong>Create Rule</strong>と<strong>Save Changes</strong>をクリックします。</p>
<h2 is-upgraded>確認</h2>
<p>作業が完了したら、Dynatraceで変更を確認することができます。</p>
<p class="image-container"><img alt="JSON" src="../assets/k8s/Picture17.png"></p>
<h2 is-upgraded>サービス名の命名規則</h2>
<p><strong>Settings -&gt; Server-side service monitoring -&gt; Service naming rules</strong>へ移動し、<strong>Add a new rule</strong>をクリックします。</p>
<p>ルールに名前を付けてください（例: <strong>Kubernetes Project.Namespace.Container</strong>）</p>
<p><code>{Service:DetectedName}.{ProcessGroup:KubernetesNamespace}</code> という形式で入力してください。</p>
<p>Conditionsドロップダウンリストでは, <strong>Kubernetes namespace</strong>と<strong>exists</strong>を選択します。</p>
<p class="image-container"><img alt="JSON" src="../assets/k8s/Picture18.png"></p>
<p><strong>Preview</strong>をクリックし、マッチしているエントリーを確認します。</p>
<p class="image-container"><img alt="JSON" src="../assets/k8s/Picture19.png"></p>
<p><strong>Create Rule</strong>と<strong>Save Changes</strong>をクリックします。</p>
<h2 is-upgraded>確認</h2>
<p>作業が完了したら、Dynatraceで変更を確認することができます。</p>
<p class="image-container"><img alt="JSON" src="../assets/k8s/Picture20.png"></p>



      </google-codelab-step>
    
      <google-codelab-step label="Monitoring-as-Code" duration="10">
        <p>この演習では、Dynatrace環境の設定を自動化します。</p>
<p><a href="https://github.com/dynatrace-oss/dynatrace-monitoring-as-code" target="_blank">Dynatrace Monitoring as Code (Monaco)</a>を使用して、すべてのグローバルなDynatrace環境の設定を人手を介さずに自動化することができます。 以下の様々なユースケースがあります。</p>
<ul>
<li>複数の環境で再利用できるように、構成をテンプレート化する機能を持つこと</li>
<li>コンフィグレーション間の相互依存性は、一意の識別子を追跡することなく処理する必要があります。</li>
<li>同じコンフィグレーションを何百ものDynatrace環境に簡単に適用・更新できる機能を導入し、特定の環境にロールアウトすることができます。</li>
<li>アプリケーション固有の構成をある環境から別の環境へと促進するための簡単な方法を特定し、開発からハードニング、本番までのデプロイメントを追跡します。</li>
<li>プルリクエスト、マージ、承認など、gitベースのワークフローのすべてのメカニズムとベストプラクティスをサポートする。</li>
<li>コンフィグレーションは、開発からハードニング、本番へのデプロイメント後、1つの環境から別の環境へと簡単に昇格できなければなりません。</li>
</ul>
<p>セッションを円滑に進めるために、以下のコードを実行します。</p>
<pre><code language="language-bash" class="language-bash">cd sockshop
./deploy-monaco.sh
</code></pre>
<p>コマンドの実行後に、<strong>DT_TENANT</strong>と<strong>DT_API_TOKEN</strong>と<strong>DT_DASHBOARD_OWNER</strong>の変数を設定します。 これらは、ラボの登録メール内に記載されています。</p>
<pre><code language="language-bash" class="language-bash">export DT_TENANT= https://mou612.managed-sprint.dynalabs.io/e/&lt;ENV&gt;
export DT_API_TOKEN=dt0c01.IH6********************************************
export DT_DASHBOARD_OWNER=&lt;your email address&gt;
</code></pre>
<p>コマンドの実行後に、以下のコマンドを実行してDynatraceの設定を行います。</p>
<pre><code language="language-bash" class="language-bash">./push-monaco.sh 
</code></pre>
<p>以下の設定が自動的に行われました。</p>
<ul>
<li>シンセティック・モニタリング</li>
<li>サービスネーミングルール</li>
<li>カートSLO</li>
<li>アプリケーション定義</li>
<li>ダッシュボード</li>
<li>プロセスのネーミングルール</li>
<li>管理ゾーン</li>
</ul>



      </google-codelab-step>
    
      <google-codelab-step label="Kubernetes Dashboards" duration="10">
        <h2 is-upgraded>Kubernetes Cluster Overview</h2>
<p>Kubernetesクラスタの使用率を確認することができます。すべてのノードおよびネームスペースごとにCPUおよびメモリのリクエストとリミットを 確認することができます。 また、<strong>filter bar</strong>を使ってダッシュボードをフィルタリングすることもできます。</p>
<p class="image-container"><img alt="#" src="../assets/k8s/k8s-cluster-overview.png"></p>
<h2 is-upgraded>Kubernetes Workload Overview</h2>
<p>ネームスペースに割り当てられたKubernetesのワークロードとその使用状況の概要を確認することができます。 また、<strong>filter bar</strong>を使ってダッシュボードをフィルタリングすることもできます。</p>
<p class="image-container"><img alt="#" src="../assets/k8s/k8s-workload-overview.png"></p>
<h2 is-upgraded>Prometheus Overview</h2>
<p>先のステップでMonacoが生成したPrometheusダッシュボード内で、Prometheusが収集したメトリクスの概要を確認します。</p>
<p class="image-container"><img alt="#" src="../assets/k8s/prometheus-dashboard.png"></p>



      </google-codelab-step>
    
      <google-codelab-step label="Dynatrace上でのKubernetes情報の確認" duration="20">
        <p>Kubernetes View内の様々な機能（クラスタの使用状況、クラスタのワークロード、K8Sイベントなど）を確認できます。</p>
<ul>
<li>左のメニューから、<strong>Kubernetes</strong>でフィルターすることで簡単にアクセスできます。</li>
</ul>
<p class="image-container"><img alt="KubernetesUI" src="../assets/get-started-openshift/k8s-ui.png"></p>
<h2 is-upgraded>Kubernetes Clusterの利用状況の分析</h2>
<ul>
<li>マウスオーバーして、CPUとメモリの使用量を最小／最大で表示します。</li>
<li>各ノードの詳細を調べるには、<strong>Analyze Nodes</strong>をクリックします。</li>
</ul>
<p class="image-container"><img alt="KubernetesUI" src="../assets/get-started-openshift/cluster-util.png"></p>
<h2 is-upgraded>Kubernetesクラスタのワークロードの分析</h2>
<ul>
<li>ワークロードとポッドを種別毎に確認することができます。</li>
</ul>
<p class="image-container"><img alt="KubernetesUI" src="../assets/k8s/cluster-workload.png"></p>
<h2 is-upgraded>Kubernetes イベントの分析</h2>
<ul>
<li>BackOffやUnhealthyなどタイプ毎に確認することができます。</li>
</ul>
<p class="image-container"><img alt="KubernetesUI" src="../assets/k8s/events.png"></p>
<h2 is-upgraded>Kubernetes Workloadsを調べる</h2>
<ul>
<li>それぞれをクリックすると、対応する技術が表示されます。</li>
</ul>
<p class="image-container"><img alt="KubernetesUI" src="../assets/get-started-openshift/kubernetes-workloads.png"></p>
<h2 is-upgraded>Kubernetesの名前空間とそのワークロードを調べる</h2>
<ul>
<li>それぞれをクリックすると、使用率とワークロードが表示されます。</li>
</ul>
<p class="image-container"><img alt="KubernetesUI" src="../assets/get-started-openshift/kubernetes-namespace.png"></p>



      </google-codelab-step>
    
      <google-codelab-step label="Kubernetesワークロードのインテリジェントオブザーバビリティ" duration="10">
        <h2 is-upgraded>ワークロードのリソース使用量の管理</h2>
<p>Kubernetesプラットフォームは、多くの仮想化および抽象化レイヤーの上に構築されていますが、ワークロードが使用しているリソースを意識する必要があります。</p>
<p>これは、Kubernetesが通常、共有インフラ上で動作するプラットフォームとして設計されているため、あなたが使用するリソースの量が、同じクラスタ上で動作する他のアプリケーションに影響を与える可能性があるためです。</p>
<h2 is-upgraded>シナリオ</h2>
<ul>
<li>Kubernetesプラットフォームの管理者は、プロジェクト（名前空間）が遵守する必要のあるリソースクォータを設定します。</li>
<li>アプリケーションチームは、指定されたリソースを異なるマイクロサービスに割り当てる責任があります。</li>
<li>以下のコマンドを実行して、このデプロイメントを適用します。</li>
</ul>
<pre><code language="language-bash" class="language-bash">  cd sockshop
  ./deploy_newbuild.sh
</code></pre>
<p>あなたのDynatraceコンソールから目を離さないでください...何が起こるかわかりません。</p>
<p>ある時、appsチームとk8s infraチームの両方が、Dynatraceからのアラートを受け取りました。それを見てみましょう。</p>
<p class="image-container"><img alt="oomkill-container" src="../assets/k8s/oomkill-problemcard1.png"></p>
<aside class="warning"><p>何が起こったのでしょうか？どの<strong>service</strong>に影響がありましたか？どの<strong>namespace</strong>で起きましたか？</p>
</aside>
<p>新しいカートサービスポッドのコンテナが<strong>OOMKilled</strong>されました。これは、メモリ使用量が設定された上限を超えたことを意味します。今日まで、OOMKilledの問題は発生していませんでした。</p>
<p>コンテナをクリックすると、コンテナービューにドリルダウンします。</p>
<p class="image-container"><img alt="oomkill-container" src="../assets/k8s/oomkill-problemcard2.png"></p>
<p>コンテナビューには、リソースの消費状況を明確に把握するために必要なすべてのメトリクスとデータポイントが表示されます。</p>
<p class="image-container"><img alt="oomkill-memory" src="../assets/k8s/oomkill-memory.png"></p>
<p>これは新しいビルドと関係があり、次のどちらかが問題の原因となります。</p>
<ol type="1">
<li>コンテナのメモリ制限が間違って設定されていた</li>
<li>新しいビルドにメモリリークがあり、時間の経過とともに制限値以上のメモリを消費している。  <ul>
<li>このような場合、いくらメモリ制限を増やしても、結局は制限を超えてしまいます。これでは時間稼ぎをしているだけで、コード自体を修正する必要があります。</li>
<li>さまざまな条件でテストを行い、Javaのメモリメトリクスをプロセスビューから監視します。Dynatraceは、必要となるすべてのメトリクスを提供しています。</li>
</ul>
</li>
</ol>
<p class="image-container"><img alt="oomkill-memory" src="../assets/k8s/oomkill-memory-trends.png"></p>
<p>開発チームはすぐにこの問題を発見し、修正を行いました。この問題は、設定上の問題に関連しています。コンテナのメモリ制限が誤って設定されていました。</p>
<p>ターミナルでは、修正を適用するために実行します。</p>
<pre><code language="language-bash" class="language-bash">kubectl apply -f ~/sockshop/manifests/sockshop-app/newbuilds/newbuild-quota-fix.yml
</code></pre>
<h2 is-upgraded>教訓として</h2>
<ul>
<li>Kubernetesにおけるリソース管理は重要です。</li>
<li>インフラやクラウドサービスでは、リソースは常に制限されており、コストがかかります。</li>
<li>ワークロードのリソース消費量を把握することは、様々なサービスに対してどのような要求や制限を設定すべきかを把握するための鍵となります。</li>
</ul>
<p>k8sのインフラ運用チームは、常に必要な分だけのリソースを提供してくれます。彼らの責任は、プラットフォームを利用するすべての人のために、プラットフォームが健全に保たれるようにすることです。そのため、より多くのリソースが必要な場合には、プラットフォームチームと交渉しなければなりません。どのような交渉でも、できるだけ多くの情報を持ってテーブルにつくことが大切です。</p>
<p>そのためには、Dynatraceが頼りになります。</p>



      </google-codelab-step>
    
      <google-codelab-step label="アンケート" duration="3">
        <p>このラボを楽しんでいただき、お役に立てれば幸いです。ご意見、ご感想をお待ちしております。 </p>
<google-codelab-survey survey-id="kubernetes-jp-1">
<h4>このラボでの全体的な経験はどうでしたか？</h4>
<paper-radio-group>
<paper-radio-button>とても良い</paper-radio-button>
<paper-radio-button>良い</paper-radio-button>
<paper-radio-button>普通</paper-radio-button>
<paper-radio-button>悪い</paper-radio-button>
<paper-radio-button>とても悪い</paper-radio-button>
</paper-radio-group>
</google-codelab-survey>
<google-codelab-survey survey-id="kubernetes-jp-2">
<h4>このラボで最も役立ったことは何ですか？</h4>
<paper-radio-group>
<paper-radio-button>Dynatrace Operatorを使ってKubernetesにデプロイする方法</paper-radio-button>
<paper-radio-button>Kubernetesの統合の設定</paper-radio-button>
<paper-radio-button>Kubernetesのプロセスグループネーミングとサービスネーミング</paper-radio-button>
<paper-radio-button>DynatraceにおけるKubernetesの理解</paper-radio-button>
</paper-radio-group>
</google-codelab-survey>
<google-codelab-survey survey-id="kubernetes-jp-3">
<h4>このラボを友人や同僚に勧める可能性はどの程度ありますか？</h4>
<paper-radio-group>
<paper-radio-button>強く勧めたい</paper-radio-button>
<paper-radio-button>勧めたい</paper-radio-button>
<paper-radio-button>わからない</paper-radio-button>
<paper-radio-button>勧めない</paper-radio-button>
<paper-radio-button>全く勧めない</paper-radio-button>
</paper-radio-group>
</google-codelab-survey>
<aside class="special"><p>💡 その他のアイデアや提案については、<a href="mailto:DT-TYO-SE@dynatrace.com?subject=DynatraceとKubernetes - アイデア、提案" target="_blank">メールでのお問い合わせ</a> をお願いします。</p>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="../../elements/codelab-elements/native-shim.js"></script>
  <script src="../../elements/codelab-elements/custom-elements.min.js"></script>
  <script src="../../elements/codelab-elements/prettify.js"></script>
  <script src="../../elements/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
